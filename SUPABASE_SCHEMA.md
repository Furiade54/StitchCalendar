# Esquema de Base de Datos para Supabase

Este documento define la estructura de tablas y relaciones necesarias para migrar la aplicación Stitch a Supabase (PostgreSQL).

## 1. Tabla: `profiles` (Usuarios)
Extiende la tabla de autenticación por defecto de Supabase (`auth.users`).

```sql
create table public.profiles (
  id uuid references auth.users not null primary key,
  username text unique,
  full_name text,
  avatar_url text,
  website text,
  updated_at timestamp with time zone,
  
  constraint username_length check (char_length(username) >= 3)
);

-- Habilitar Row Level Security (RLS)
alter table public.profiles enable row level security;

-- Política: Los usuarios pueden ver todos los perfiles públicos
create policy "Public profiles are viewable by everyone."
  on profiles for select
  using ( true );

-- Política: Los usuarios solo pueden insertar/actualizar su propio perfil
create policy "Users can insert their own profile."
  on profiles for insert
  with check ( auth.uid() = id );

create policy "Users can update own profile."
  on profiles for update
  using ( auth.uid() = id );
```

## 2. Tabla: `event_types` (Tipos de Evento)
Define los tipos de eventos personalizados por usuario (o globales).

```sql
create table public.event_types (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users not null, -- Dueño del tipo
  name text not null, -- "reunión", "cita"
  label text not null, -- "Reunión de Equipo"
  icon text not null, -- Material Icon name
  color_class text not null, -- Tailwind class: "text-blue-500"
  icon_bg_class text not null, -- Tailwind class: "bg-blue-500/10"
  requires_end_time boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- Evitar duplicados de nombre para el mismo usuario
  unique(user_id, name)
);

alter table public.event_types enable row level security;

-- Política: Usuarios solo ven y editan sus propios tipos
create policy "Users can CRUD their own event types."
  on event_types for all
  using ( auth.uid() = user_id );
```

## 3. Tabla: `events` (Eventos del Calendario)
Tabla principal de eventos. Utiliza referencias FK a `event_types`.

```sql
create table public.events (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null,
  event_type_id uuid references public.event_types, -- Relación FK
  
  title text not null,
  start_date timestamp with time zone not null,
  end_date timestamp with time zone,
  
  status text check (status in ('programado', 'en_curso', 'completado', 'vencido', 'cancelado')) default 'programado',
  
  is_recurring boolean default false,
  meeting_url text,
  notes text,
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.events enable row level security;

-- Política: Usuarios solo ven y editan sus propios eventos
create policy "Users can CRUD their own events."
  on events for all
  using ( auth.uid() = user_id );
```

## 4. Notas de Migración
- **Backend Asíncrono**: El código actual en `dataService.js` ya utiliza `async/await` y Promesas, por lo que la transición a `supabase.from(...).select(...)` será directa.
- **Normalización**: El código ha sido refactorizado para "hidratar" los eventos uniendo (`JOIN`) la tabla `events` con `event_types` en tiempo de lectura. Esto asegura que si cambias el color de un tipo de evento, todos los eventos históricos se actualizan visualmente.
